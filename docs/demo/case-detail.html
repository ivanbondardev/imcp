<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Case #F1-SEA-2026-02451 — IMCP</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <a href="../index.html" class="sidebar-logo" style="text-decoration: none; color: inherit;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2L2 7l10 5 10-5-10-5z"/>
          <path d="M2 17l10 5 10-5"/>
          <path d="M2 12l10 5 10-5"/>
        </svg>
        <div>
          <h1>IMCP</h1>
          <span>Case Platform</span>
        </div>
      </a>

      <nav>
        <ul class="sidebar-nav">
          <li>
            <a href="owner-dashboard.html">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="7" height="7"/>
                <rect x="14" y="3" width="7" height="7"/>
                <rect x="14" y="14" width="7" height="7"/>
                <rect x="3" y="14" width="7" height="7"/>
              </svg>
              Owner Dashboard
            </a>
          </li>
          <li>
            <a href="engineering-dashboard.html">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
              </svg>
              Engineering
            </a>
          </li>
          <li>
            <a href="case-list.html" class="active">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
              </svg>
              Кейси
              <span class="nav-badge">12</span>
            </a>
          </li>
          <li>
            <a href="approvals.html">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="9 11 12 14 22 4"/>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
              </svg>
              Підтвердження
              <span class="nav-badge">3</span>
            </a>
          </li>
          <li>
            <a href="documents.html">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
              Документи
            </a>
          </li>
          <li>
            <a href="timeline.html">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
              </svg>
              Таймлайн
            </a>
          </li>
        </ul>

        <div class="sidebar-section">
          <div class="sidebar-section-title">Цей кейс</div>
          <ul class="sidebar-nav">
            <li>
              <a href="#nba">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                </svg>
                Next Best Action
              </a>
            </li>
            <li>
              <a href="#documents">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/>
                </svg>
                Документи
              </a>
            </li>
            <li>
              <a href="#timeline">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
                Історія
              </a>
            </li>
          </ul>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-section-title">Налаштування</div>
          <ul class="sidebar-nav">
            <li>
              <a href="personal-settings.html">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="3"/>
                  <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                Персональні
              </a>
            </li>
          </ul>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Case Header -->
      <header class="case-header">
        <div class="case-header-top">
          <div class="case-id">
            <a href="case-list.html" class="btn btn-ghost btn-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="19" y1="12" x2="5" y2="12"/>
                <polyline points="12 19 5 12 12 5"/>
              </svg>
            </a>
            <span class="case-type-badge">F1_SEA_IMPORT</span>
            F1-SEA-2026-02451
          </div>
          <div class="btn-group">
            <button class="btn btn-secondary">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="1"/>
                <circle cx="19" cy="12" r="1"/>
                <circle cx="5" cy="12" r="1"/>
              </svg>
              Ще
            </button>
          </div>
        </div>
        <div class="case-meta">
          <div class="case-meta-item">
            <span class="status-badge status-pending" id="caseStateBadge">QUOTE_APPROVAL_PENDING</span>
          </div>
          <div class="case-meta-item">
            <span class="status-badge status-open" id="caseStatusBadge">OPEN</span>
          </div>
          <div class="case-meta-item sla-warning">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            SLA: 2d 4h
          </div>
          <div class="case-meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
            Owner: Іван П.
          </div>
          <div class="case-meta-item priority-urgent">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
              <line x1="12" y1="9" x2="12" y2="13"/>
              <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            Urgent
          </div>
          <div class="case-meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
            </svg>
            Client: ACME Ltd
          </div>
        </div>
      </header>

      <!-- Content -->
      <div class="page-content">
        <!-- Next Best Action -->
        <div class="nba-card" id="nba">
          <span class="help-trigger" data-help="nba-section">?</span>
          <div class="nba-header">
            <span class="nba-indicator"></span>
            <span class="nba-label">Next Best Action</span>
          </div>
          <h3 class="nba-title">Підтвердити калькуляцію (QUOTE_APPROVAL)</h3>
          <div class="nba-meta" style="display:flex; gap:10px; align-items:center; font-size:12px; color: var(--text-muted); margin-bottom: 10px;">
            <span>Approval ID: <code id="nbaApprovalId">APR-QUOTE-0001</code></span>
            <span>•</span>
            <button class="btn btn-sm btn-ghost" id="openApprovalDetailsBtn" type="button">Деталі →</button>
          </div>
          <div class="nba-description">
            <ul>
              <li>Система підготувала розрахунок ціни</li>
              <li>Термін дії ціни: 7–9 днів</li>
              <li>Base cost: $2,450 + Margin: $350 = Total: $2,800</li>
            </ul>
          </div>
          <div class="nba-risk">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
              <line x1="12" y1="9" x2="12" y2="13"/>
              <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            Ризик: габарити клієнта ще не верифіковані складом
          </div>
          <div class="nba-actions">
            <button class="btn btn-lg" id="nbaApproveBtn" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
              Approve
            </button>
            <button class="btn btn-lg btn-secondary" id="nbaEditApproveBtn" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 20h9"/>
                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
              </svg>
              Edit & Approve
            </button>
            <button class="btn btn-lg btn-secondary" id="nbaRejectBtn" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
              Reject
            </button>
          </div>
        </div>

        <!-- Cockpit Grid -->
        <div class="cockpit-grid">
          <!-- Main Panel -->
          <div class="main-panel">
            <!-- Approvals (PoC: show pending approvals as first-class objects) -->
            <div class="card mb-4" id="approvals">
              <div class="card-header">
                <h4 class="flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 11 12 14 22 4"/>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                  </svg>
                  Approvals
                  <span class="help-trigger" data-help="approvals-section">?</span>
                </h4>
                <span class="badge badge-warning" id="pendingApprovalsCount">1 PENDING</span>
              </div>
              <ul class="doc-list">
                <li class="doc-item">
                  <div class="doc-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="9 11 12 14 22 4"/>
                      <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    </svg>
                  </div>
                  <div class="doc-info">
                    <div class="doc-name">QUOTE_APPROVAL</div>
                    <div class="doc-meta">
                      <span>PENDING</span>
                      <span>•</span>
                      <span>requested by SYSTEM</span>
                      <span>•</span>
                      <span id="approvalRequestedAt">12:10 сьогодні</span>
                    </div>
                  </div>
                  <span class="badge badge-warning">PENDING</span>
                  <div class="doc-actions">
                    <button class="btn btn-sm btn-primary" id="openApprovalFromListBtn" type="button">Review</button>
                  </div>
                </li>
              </ul>
            </div>

            <!-- Quote Draft -->
            <div class="quote-draft mb-4">
              <span class="help-trigger" data-help="quote-section">?</span>
              <div class="quote-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="12" y1="1" x2="12" y2="23"/>
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
                <h4>Quote Draft</h4>
                <span class="badge badge-info" style="margin-left: auto;">Version 1</span>
              </div>
              <div class="quote-body">
                <div class="quote-row">
                  <span class="quote-label">Base freight cost</span>
                  <span class="quote-value">$1,850</span>
                </div>
                <div class="quote-row">
                  <span class="quote-label">Terminal handling</span>
                  <span class="quote-value">$350</span>
                </div>
                <div class="quote-row">
                  <span class="quote-label">Documentation fee</span>
                  <span class="quote-value">$150</span>
                </div>
                <div class="quote-row">
                  <span class="quote-label">Insurance (optional)</span>
                  <span class="quote-value">$100</span>
                </div>
                <div class="quote-row">
                  <span class="quote-label" style="font-weight: 500;">Subtotal (Base cost)</span>
                  <span class="quote-value">$2,450</span>
                </div>
                <div class="quote-row">
                  <span class="quote-label">Margin</span>
                  <span class="quote-value">$350</span>
                </div>
                <div class="quote-row total">
                  <span class="quote-label">Total</span>
                  <span class="quote-value" style="color: var(--success);">$2,800</span>
                </div>

                <div class="quote-assumptions">
                  <div class="quote-assumptions-title">Assumptions</div>
                  <ul>
                    <li>Stackable cargo</li>
                    <li>No dangerous goods</li>
                    <li>Standard container load</li>
                    <li>Yiwu → Shenzhen → Odessa → Kyiv</li>
                  </ul>
                </div>

                <div class="quote-notes">
                  <strong>Validity:</strong> 7–9 days from issue date
                </div>
              </div>
            </div>

            <!-- Documents Section -->
            <div class="card mb-4" id="documents">
              <div class="card-header">
                <h4 class="flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                  </svg>
                  Документи
                  <span class="help-trigger" data-help="documents-section">?</span>
                </h4>
                <button class="btn btn-sm btn-primary" data-upload-trigger>
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                  </svg>
                  Завантажити
                </button>
              </div>
              <ul class="doc-list">
                <li class="doc-item">
                  <div class="doc-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14 2 14 8 20 8"/>
                    </svg>
                  </div>
                  <div class="doc-info">
                    <div class="doc-name">Contract_ACME_2026.pdf</div>
                    <div class="doc-meta">
                      <span>CONTRACT</span>
                      <span>•</span>
                      <span>CLIENT</span>
                      <span>•</span>
                      <span>2.4 MB</span>
                    </div>
                  </div>
                  <span class="badge badge-success">VERIFIED</span>
                  <div class="doc-actions">
                    <button class="btn btn-sm btn-ghost" data-doc-view data-doc-name="Contract_ACME_2026.pdf" data-doc-type="CONTRACT" data-doc-source="CLIENT" data-doc-case="F1-SEA-2026-02451" data-doc-confidence="97" data-doc-file="Contract ACME-2026-0451.pdf" data-doc-status="VERIFIED">View</button>
                  </div>
                </li>
                <li class="doc-item">
                  <div class="doc-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14 2 14 8 20 8"/>
                    </svg>
                  </div>
                  <div class="doc-info">
                    <div class="doc-name">Packing_List_GT2026.xlsx</div>
                    <div class="doc-meta">
                      <span>PACKING_LIST</span>
                      <span>•</span>
                      <span>CLIENT</span>
                      <span>•</span>
                      <span>156 KB</span>
                    </div>
                  </div>
                  <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end;">
                    <span class="badge badge-info">UPLOADED</span>
                    <span class="badge badge-warning" style="font-size:10px; padding:2px 8px;">NEEDS HUMAN REVIEW</span>
                  </div>
                  <div class="doc-actions">
                    <button class="btn btn-sm btn-primary" data-doc-view data-doc-name="Packing_List_GT2026.xlsx" data-doc-type="PACKING_LIST" data-doc-source="CLIENT" data-doc-case="F1-SEA-2026-02451" data-doc-confidence="88" data-doc-file="Packing_List_GT2026.xlsx" data-doc-status="UPLOADED">Review</button>
                  </div>
                </li>
                <li class="doc-item">
                  <div class="doc-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14 2 14 8 20 8"/>
                    </svg>
                  </div>
                  <div class="doc-info">
                    <div class="doc-name">POA_Scan_TechImport.pdf</div>
                    <div class="doc-meta">
                      <span>POA</span>
                      <span>•</span>
                      <span>CLIENT</span>
                      <span>•</span>
                      <span>380 KB</span>
                    </div>
                  </div>
                  <span class="badge badge-success">VERIFIED</span>
                  <div class="doc-actions">
                    <button class="btn btn-sm btn-ghost" data-doc-view data-doc-name="POA_Scan_TechImport.pdf" data-doc-type="POA" data-doc-source="CLIENT" data-doc-case="F1-SEA-2026-02451" data-doc-confidence="96" data-doc-file="POA_Scan_TechImport.pdf" data-doc-status="VERIFIED">View</button>
                  </div>
                </li>
              </ul>
            </div>

            <!-- Timeline -->
            <div class="card" id="timeline">
              <div class="card-header">
                <h4 class="flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                  </svg>
                  Timeline
                  <span class="help-trigger" data-help="timeline-section">?</span>
                </h4>
                <a href="timeline.html" class="btn btn-sm btn-ghost">Всі події →</a>
              </div>
              <div class="card-body">
                <div class="timeline" id="timelineList">
                  <div class="timeline-item">
                    <div class="timeline-marker system">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"/>
                      </svg>
                    </div>
                    <div class="timeline-content">
                      <div class="timeline-header">
                        <span class="timeline-actor">SYSTEM</span>
                        <span class="timeline-time">12:10 сьогодні</span>
                      </div>
                      <div class="timeline-event">APPROVAL_CREATED</div>
                      <div class="timeline-details">Created QUOTE_APPROVAL for review</div>
                    </div>
                  </div>

                  <div class="timeline-item">
                    <div class="timeline-marker system">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="23 4 23 10 17 10"/>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                      </svg>
                    </div>
                    <div class="timeline-content">
                      <div class="timeline-header">
                        <span class="timeline-actor">SYSTEM</span>
                        <span class="timeline-time">12:10 сьогодні</span>
                      </div>
                      <div class="timeline-event">STATE_CHANGED</div>
                      <div class="timeline-details">QUOTE_READY → QUOTE_APPROVAL_PENDING</div>
                    </div>
                  </div>

                  <div class="timeline-item">
                    <div class="timeline-marker system">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="1" x2="12" y2="23"/>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                      </svg>
                    </div>
                    <div class="timeline-content">
                      <div class="timeline-header">
                        <span class="timeline-actor">SYSTEM</span>
                        <span class="timeline-time">12:08 сьогодні</span>
                      </div>
                      <div class="timeline-event">QUOTE_CALCULATED</div>
                      <div class="timeline-details">Quote draft generated: $2,800 total</div>
                    </div>
                  </div>

                  <div class="timeline-item">
                    <div class="timeline-marker human">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                      </svg>
                    </div>
                    <div class="timeline-content">
                      <div class="timeline-header">
                        <span class="timeline-actor">HUMAN (Іван П.)</span>
                        <span class="timeline-time">11:42 сьогодні</span>
                      </div>
                      <div class="timeline-event">STATE_CHANGED</div>
                      <div class="timeline-details">CLIENT_INFO_COLLECTED → QUOTE_READY (all required fields confirmed)</div>
                    </div>
                  </div>

                  <div class="timeline-item">
                    <div class="timeline-marker ai">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5"/>
                      </svg>
                    </div>
                    <div class="timeline-content">
                      <div class="timeline-header">
                        <span class="timeline-actor">AI</span>
                        <span class="timeline-time">10:30 сьогодні</span>
                      </div>
                      <div class="timeline-event">DOC_EXTRACTED</div>
                      <div class="timeline-details">Extracted cargo data from email attachment (confidence: 92%)</div>
                    </div>
                  </div>

                  <div class="timeline-item">
                    <div class="timeline-marker human">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                      </svg>
                    </div>
                    <div class="timeline-content">
                      <div class="timeline-header">
                        <span class="timeline-actor">HUMAN (Іван П.)</span>
                        <span class="timeline-time">09:55 сьогодні</span>
                      </div>
                      <div class="timeline-event">CASE_CREATED</div>
                      <div class="timeline-details">Case created from client request</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Context Sidebar -->
          <div class="context-sidebar">
            <!-- Cargo Summary -->
            <div class="card context-card">
              <span class="help-trigger" data-help="cargo-summary">?</span>
              <div class="context-card-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                </svg>
                Cargo Summary
              </div>
              <div class="context-card-body">
                <div class="context-item">
                  <span class="context-item-label">Packages</span>
                  <span class="context-item-value">12</span>
                </div>
                <div class="context-item">
                  <span class="context-item-label">Declared dims</span>
                  <span class="context-item-value">3.2 cbm</span>
                </div>
                <div class="context-item">
                  <span class="context-item-label">Weight</span>
                  <span class="context-item-value">450 kg</span>
                </div>
                <div class="context-item">
                  <span class="context-item-label">Stackable</span>
                  <span class="context-item-value">Yes</span>
                </div>
                <div class="context-item">
                  <span class="context-item-label">Dangerous</span>
                  <span class="context-item-value">No</span>
                </div>
                <div class="context-item">
                  <span class="context-item-label">Description</span>
                  <span class="context-item-value">Consumer electronics</span>
                </div>
              </div>
            </div>

            <!-- Route Info -->
            <div class="card context-card">
              <span class="help-trigger" data-help="route-info">?</span>
              <div class="context-card-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M2 12h20"/>
                  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                </svg>
                Route
              </div>
              <div class="context-card-body">
                <div class="context-item">
                  <span class="context-item-label">Mode</span>
                  <span class="context-item-value">SEA</span>
                </div>
                <div class="context-item">
                  <span class="context-item-label">Origin</span>
                  <span class="context-item-value">Yiwu Warehouse</span>
                </div>
                <div class="context-item">
                  <span class="context-item-label">Port</span>
                  <span class="context-item-value">Shenzhen</span>
                </div>
                <div class="context-item">
                  <span class="context-item-label">Destination</span>
                  <span class="context-item-value">Kyiv</span>
                </div>
                <div class="context-item">
                  <span class="context-item-label">Terminal</span>
                  <span class="context-item-value">Terminal X</span>
                </div>
                <div class="context-item">
                  <span class="context-item-label">Broker</span>
                  <span class="context-item-value">Our broker</span>
                </div>
              </div>
            </div>

            <!-- Client Info -->
            <div class="card context-card">
              <div class="context-card-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                  <circle cx="12" cy="7" r="4"/>
                </svg>
                Client
              </div>
              <div class="context-card-body">
                <div class="context-item">
                  <span class="context-item-label">Company</span>
                  <span class="context-item-value">ACME Ltd</span>
                </div>
                <div class="context-item">
                  <span class="context-item-label">Contact</span>
                  <span class="context-item-value">John Smith</span>
                </div>
                <div class="context-item">
                  <span class="context-item-label">Email</span>
                  <span class="context-item-value">john@acme.com</span>
                </div>
                <div class="context-item">
                  <span class="context-item-label">Phone</span>
                  <span class="context-item-value">+380 50 123 4567</span>
                </div>
              </div>
            </div>

            <!-- Key Dates -->
            <div class="card context-card">
              <div class="context-card-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                  <line x1="16" y1="2" x2="16" y2="6"/>
                  <line x1="8" y1="2" x2="8" y2="6"/>
                  <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                Key Dates
              </div>
              <div class="context-card-body">
                <div class="context-item">
                  <span class="context-item-label">Cargo ready</span>
                  <span class="context-item-value">2026-02-10</span>
                </div>
                <div class="context-item">
                  <span class="context-item-label">Created</span>
                  <span class="context-item-value">2026-02-05</span>
                </div>
                <div class="context-item">
                  <span class="context-item-label">SLA deadline</span>
                  <span class="context-item-value">2026-02-07</span>
                </div>
              </div>
            </div>

            <!-- Required Fields -->
            <div class="card context-card">
              <span class="help-trigger" data-help="required-fields">?</span>
              <div class="context-card-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M9 11l3 3L22 4"/>
                  <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                </svg>
                Required Fields (this state)
              </div>
              <div class="context-card-body" id="requiredFieldsCardBody">
                <div class="required-field-row">
                  <span class="required-field-label">Client name</span>
                  <span class="required-field-status ok">✅ filled</span>
                </div>
                <div class="required-field-row">
                  <span class="required-field-label">Origin warehouse</span>
                  <span class="required-field-status ok">✅ filled</span>
                </div>
                <div class="required-field-row">
                  <span class="required-field-label">Cargo ready date</span>
                  <span class="required-field-status ok">✅ filled</span>
                </div>
                <div class="required-field-row">
                  <span class="required-field-label">Dimensions</span>
                  <span class="required-field-status warn">⚠️ needs verification</span>
                </div>
                <div class="required-field-row">
                  <span class="required-field-label">Broker owner</span>
                  <span class="required-field-status ok">✅ filled</span>
                </div>
                <div class="required-field-row">
                  <span class="required-field-label">Dangerous goods</span>
                  <span class="required-field-status ok">✅ no</span>
                </div>
              </div>
            </div>

            <!-- Risk Flags -->
            <div class="card context-card">
              <span class="help-trigger" data-help="risk-flags">?</span>
              <div class="context-card-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                  <line x1="12" y1="9" x2="12" y2="13"/>
                  <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                Risk Flags
              </div>
              <div class="context-card-body" style="padding: 10px;">
                <div class="risk-flag risk-medium">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                  </svg>
                  <span>Dimensions not verified by warehouse</span>
                </div>
                <div class="risk-flag risk-low">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                  </svg>
                  <span>No dangerous goods declared</span>
                </div>
              </div>
            </div>

            <!-- Integration IDs -->
            <div class="card context-card">
              <span class="help-trigger" data-help="integration-ids">?</span>
              <div class="context-card-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="16 18 22 12 16 6"/>
                  <polyline points="8 6 2 12 8 18"/>
                </svg>
                Integrations
              </div>
              <div class="context-card-body">
                <div class="context-item">
                  <span class="context-item-label">1C Request</span>
                  <span class="context-item-value"><code>REQ-2026-02451</code></span>
                </div>
                <div class="context-item">
                  <span class="context-item-label">1C Sync</span>
                  <span class="context-item-value"><span class="badge badge-warning" style="font-size:10px;">PENDING</span></span>
                </div>
                <div class="context-item">
                  <span class="context-item-label">Marking</span>
                  <span class="context-item-value"><code>ALEX-02451</code></span>
                </div>
                <div class="context-item">
                  <span class="context-item-label">Last sync</span>
                  <span class="context-item-value">—</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <style>
    /* ===== Onboarding Tips System ===== */
    .tip {
      position: absolute;
      background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%);
      color: white;
      padding: 12px 16px;
      border-radius: var(--radius-lg);
      font-size: 12px;
      max-width: 280px;
      box-shadow: 0 8px 32px rgba(0, 120, 212, 0.3);
      z-index: 100;
      animation: tipPulse 0.4s ease-out, tipGlow 2s ease-in-out infinite;
    }

    @keyframes tipPulse {
      0% { opacity: 0; transform: scale(0.9) translateY(10px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }

    @keyframes tipGlow {
      0%, 100% { box-shadow: 0 8px 32px rgba(0, 120, 212, 0.3); }
      50% { box-shadow: 0 8px 40px rgba(0, 120, 212, 0.5); }
    }

    .tip.hiding {
      animation: tipHide 0.3s ease-in forwards;
    }

    @keyframes tipHide {
      to { opacity: 0; transform: scale(0.95) translateY(-10px); }
    }

    .tip-content {
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .tip-icon {
      flex-shrink: 0;
      width: 24px;
      height: 24px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tip-icon svg { width: 14px; height: 14px; }

    .tip-text { flex: 1; }

    .tip-title {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .tip-description {
      opacity: 0.9;
      line-height: 1.4;
    }

    .tip-close {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .tip-close:hover { background: rgba(255, 255, 255, 0.35); }
    .tip-close svg { width: 12px; height: 12px; }

    .tip::before {
      content: '';
      position: absolute;
      width: 12px;
      height: 12px;
      background: inherit;
      transform: rotate(45deg);
    }

    .tip.arrow-top::before { top: -6px; left: 24px; }
    .tip.arrow-bottom::before { bottom: -6px; left: 24px; }
    .tip.arrow-left::before { left: -6px; top: 16px; }
    .tip.arrow-right::before { right: -6px; top: 16px; }

    .tip-step {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      opacity: 0.75;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    .tip-step-dots { display: flex; gap: 4px; }

    .tip-step-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
    }

    .tip-step-dot.active { background: white; }

    .tip-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .tip-btn {
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .tip-btn-primary { background: white; color: #005a9e; }
    .tip-btn-primary:hover { background: rgba(255, 255, 255, 0.9); }
    .tip-btn-secondary { background: rgba(255, 255, 255, 0.15); color: white; }
    .tip-btn-secondary:hover { background: rgba(255, 255, 255, 0.25); }

    .tips-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: 99;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .tips-overlay.active { opacity: 1; pointer-events: auto; }

    .tip-highlight {
      position: relative;
      z-index: 101;
      box-shadow: 0 0 0 4px rgba(0, 120, 212, 0.4);
      border-radius: var(--radius-md);
    }

    .show-tips-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: var(--radius-lg);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow-md);
      transition: all 0.2s;
      z-index: 50;
    }

    .show-tips-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-popup);
    }

    .show-tips-btn svg { width: 16px; height: 16px; }

    /* ===== Static Help Triggers ===== */
    .help-trigger {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      background: var(--bg-hover);
      border: 1px solid var(--divider);
      border-radius: 50%;
      color: var(--text-muted);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: 6px;
      flex-shrink: 0;
    }

    .help-trigger:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
      transform: scale(1.1);
    }

    .help-trigger.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    .help-popup {
      position: absolute;
      background: var(--bg-editor);
      border: 1px solid var(--divider);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-popup);
      padding: 12px 14px;
      font-size: 12px;
      max-width: 300px;
      z-index: 200;
      animation: helpPopupIn 0.2s ease;
    }

    @keyframes helpPopupIn {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .help-popup.closing {
      animation: helpPopupOut 0.15s ease forwards;
    }

    @keyframes helpPopupOut {
      to { opacity: 0; transform: translateY(-8px); }
    }

    .help-popup::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 20px;
      width: 10px;
      height: 10px;
      background: var(--bg-editor);
      border-left: 1px solid var(--divider);
      border-top: 1px solid var(--divider);
      transform: rotate(45deg);
    }

    .help-popup.arrow-bottom::before {
      top: auto;
      bottom: -6px;
      border-left: none;
      border-top: none;
      border-right: 1px solid var(--divider);
      border-bottom: 1px solid var(--divider);
    }

    .help-popup-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--divider);
    }

    .help-popup-icon {
      width: 24px;
      height: 24px;
      background: var(--accent-light);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent);
    }

    .help-popup-icon svg { width: 14px; height: 14px; }

    .help-popup-title { font-weight: 600; color: var(--text); }

    .help-popup-content {
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .help-popup-content ul {
      margin: 8px 0 0 0;
      padding-left: 16px;
    }

    .help-popup-content li { margin-bottom: 4px; }

    .help-popup-content code {
      background: var(--bg-panel);
      padding: 1px 4px;
      border-radius: 3px;
      font-size: 11px;
      font-family: var(--font-mono);
    }

    .help-popup-footer {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid var(--divider);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .help-popup-footer kbd {
      background: var(--bg-panel);
      border: 1px solid var(--divider);
      border-radius: 3px;
      padding: 1px 5px;
      font-size: 10px;
      font-family: var(--font-mono);
    }

    /* Positioning helpers */
    .case-header { position: relative; }
    .nba-card { position: relative; }
    .quote-draft { position: relative; }
    .context-card { position: relative; }
    .card { position: relative; }

    .case-header .help-trigger,
    .nba-card .help-trigger,
    .quote-draft .help-trigger {
      position: absolute;
      top: 12px;
      right: 12px;
    }

    .context-card .help-trigger {
      position: absolute;
      top: 8px;
      right: 8px;
    }

    .card-header .help-trigger {
      margin-left: auto;
    }

    /* ===== Required Fields Checklist ===== */
    .required-field-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 6px 0;
      font-size: 13px;
      border-bottom: 1px dashed var(--divider);
    }
    .required-field-row:last-child { border-bottom: none; }
    .required-field-label { color: var(--text-secondary); }
    .required-field-status {
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: var(--radius-sm);
      background: var(--bg-hover);
      color: var(--text-secondary);
      white-space: nowrap;
    }
    .required-field-status.ok { background: var(--success-bg); color: var(--success-text); }
    .required-field-status.warn { background: var(--warning-bg); color: var(--warning-text); }
    .required-field-status.bad { background: var(--danger-bg); color: var(--danger-text); }

    /* ===== Document Viewer Modal ===== */
    .doc-viewer-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 1000; }
    .doc-viewer-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); }
    .doc-viewer-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-editor); border: 1px solid var(--divider); border-radius: var(--radius-lg); box-shadow: var(--shadow-popup); width: 95%; max-width: 1400px; max-height: 95vh; display: flex; flex-direction: column; }
    .doc-viewer-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--divider); }
    .doc-viewer-title { display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 16px; color: var(--text); }
    .doc-viewer-title svg { color: var(--accent); }
    .doc-viewer-close { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px; border-radius: var(--radius-sm); transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
    .doc-viewer-close:hover { background: var(--bg-hover); color: var(--text); }
    .doc-viewer-body { padding: 20px; overflow-y: auto; flex: 1; }
    .doc-viewer-meta { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--divider); }
    .doc-viewer-meta-item { display: flex; flex-direction: column; gap: 4px; }
    .doc-viewer-meta-label { font-size: 12px; color: var(--text-muted); font-weight: 500; }
    .doc-viewer-meta-value { font-size: 14px; color: var(--text); }
    .doc-viewer-content-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
    @media (max-width: 900px) { .doc-viewer-content-grid { grid-template-columns: 1fr; } }
    .doc-viewer-preview { background: var(--bg-panel); border: 1px solid var(--divider); border-radius: var(--radius-md); padding: 20px; min-height: 400px; max-height: 600px; overflow-y: auto; }
    .doc-viewer-extracted { background: var(--bg-panel); border: 1px solid var(--divider); border-radius: var(--radius-md); padding: 16px; }
    .extracted-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--divider); }
    .extracted-header h4 { margin: 0; font-size: 14px; font-weight: 600; color: var(--text); }
    .extracted-badge { font-size: 11px; padding: 2px 8px; border-radius: var(--radius-sm); background: var(--bg-hover); color: var(--text-secondary); }
    .extracted-badge.high { background: var(--success-bg); color: var(--success-text); }
    .extracted-badge.medium { background: var(--warning-bg); color: var(--warning-text); }
    .extracted-badge.low { background: var(--danger-bg); color: var(--danger-text); }
    .extracted-fields { margin-bottom: 16px; max-height: 400px; overflow-y: auto; }
    .extracted-field { display: flex; flex-direction: column; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--divider); }
    .extracted-field:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .extracted-field-label { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
    .extracted-field-value { font-size: 13px; color: var(--text); font-weight: 500; }
    .extracted-actions { display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid var(--divider); }
    .checkbox-label { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-secondary); cursor: pointer; }
    .checkbox-label input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
    .doc-viewer-preview table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .doc-viewer-preview table th, .doc-viewer-preview table td { padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--divider); }
    .doc-viewer-preview table th { background: var(--bg-hover); font-weight: 600; color: var(--text); }
    .doc-viewer-preview table td { color: var(--text-secondary); }
    .doc-viewer-preview .preview-info { text-align: center; padding: 40px; color: var(--text-muted); }
    .doc-viewer-preview .preview-info svg { width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.5; }
    .doc-viewer-actions { display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid var(--divider); }
    .doc-viewer-actions .btn { display: flex; align-items: center; gap: 6px; }
    .reject-reason-modal { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1001; border-radius: var(--radius-lg); }
    .reject-reason-content { background: var(--bg-editor); border: 1px solid var(--divider); border-radius: var(--radius-lg); padding: 20px; max-width: 500px; width: 90%; box-shadow: var(--shadow-popup); }
    .reject-reason-content h4 { margin: 0 0 12px 0; font-size: 16px; font-weight: 600; color: var(--text); }
    .reject-reason-content textarea:focus { outline: none; border-color: var(--danger); }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* ===== Upload Modal ===== */
    .upload-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 1000; }
    .upload-modal-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); }
    .upload-modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-editor); border: 1px solid var(--divider); border-radius: var(--radius-lg); box-shadow: var(--shadow-popup); width: 90%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; }
    .upload-modal-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 24px; border-bottom: 1px solid var(--divider); }
    .upload-modal-header h3 { margin: 0; font-size: 18px; font-weight: 600; color: var(--text); }
    .upload-modal-close { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-sm); transition: all 0.2s; }
    .upload-modal-close:hover { background: var(--bg-hover); color: var(--text); }
    .upload-modal-body { padding: 24px; overflow-y: auto; flex: 1; }
    .upload-modal-actions { display: flex; gap: 12px; justify-content: flex-end; padding: 16px 24px; border-top: 1px solid var(--divider); }
    .upload-modal-actions .btn { display: flex; align-items: center; gap: 6px; }
    .upload-drop-zone { border: 2px dashed var(--divider); border-radius: var(--radius-md); padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.2s; background: var(--bg-panel); }
    .upload-drop-zone:hover { border-color: var(--accent); background: var(--bg-hover); }
    .upload-drop-zone.drag-over { border-color: var(--accent); background: var(--accent-bg); }
    .upload-drop-content { pointer-events: none; }
    .upload-field { margin-top: 20px; }
    .upload-select { width: 100%; padding: 10px 12px; border: 1px solid var(--divider); border-radius: var(--radius-sm); background: var(--bg-panel); color: var(--text); font-family: inherit; font-size: 13px; cursor: pointer; transition: border-color 0.2s; }
    .upload-select:focus { outline: none; border-color: var(--accent); }
    .upload-files-preview { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--divider); }
    .upload-files-list { display: flex; flex-direction: column; gap: 8px; }
    .upload-file-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: var(--bg-panel); border: 1px solid var(--divider); border-radius: var(--radius-sm); }
    .upload-file-info { display: flex; align-items: center; gap: 10px; flex: 1; }
    .upload-file-icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--accent-bg); border-radius: var(--radius-sm); color: var(--accent); }
    .upload-file-details { flex: 1; }
    .upload-file-name { font-size: 13px; font-weight: 500; color: var(--text); margin-bottom: 2px; }
    .upload-file-size { font-size: 11px; color: var(--text-muted); }
    .upload-file-remove { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-sm); transition: all 0.2s; }
    .upload-file-remove:hover { background: var(--bg-hover); color: var(--danger); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
  </style>

  <!-- Document Viewer Modal -->
  <div id="docViewerModal" class="doc-viewer-modal" style="display: none;">
    <div class="doc-viewer-overlay" onclick="DocumentViewer.close()"></div>
    <div class="doc-viewer-content">
      <!-- Reject Reason Modal (nested) -->
      <div id="rejectReasonModal" class="reject-reason-modal" style="display: none;" onclick="if(event.target === this) DocumentViewer.cancelReject()">
        <div class="reject-reason-content" onclick="event.stopPropagation()">
          <h4>Відхилити документ</h4>
          <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
            Вкажіть причину відхилення документа <strong id="rejectDocName"></strong>
          </p>
          <textarea id="rejectReasonInput" placeholder="Наприклад: Помилка в даних, неправильний формат, дублікат..." style="width: 100%; min-height: 80px; padding: 8px; border: 1px solid var(--divider); border-radius: var(--radius-sm); background: var(--bg-panel); color: var(--text); font-family: inherit; font-size: 13px; resize: vertical;"></textarea>
          <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px;">
            <button class="btn btn-secondary" onclick="DocumentViewer.cancelReject()">Скасувати</button>
            <button class="btn btn-danger" onclick="DocumentViewer.confirmReject()">Відхилити</button>
          </div>
        </div>
      </div>
      <!-- Edit Extracted Data Modal (nested) -->
      <div id="editExtractedModal" class="reject-reason-modal" style="display: none;" onclick="if(event.target === this) DocumentViewer.cancelEdit()">
        <div class="reject-reason-content" onclick="event.stopPropagation()" style="max-width: 600px;">
          <h4>Редагувати витягнуті дані</h4>
          <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
            Виправте дані, які AI витягнув з документа <strong id="editDocName"></strong>
          </p>
          <div id="editExtractedFields" style="max-height: 400px; overflow-y: auto; margin-bottom: 16px;"></div>
          <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px;">
            <button class="btn btn-secondary" onclick="DocumentViewer.cancelEdit()">Скасувати</button>
            <button class="btn btn-primary" onclick="DocumentViewer.saveEdited()">Зберегти зміни</button>
          </div>
        </div>
      </div>
      <div class="doc-viewer-header">
        <div class="doc-viewer-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
          </svg>
          <span id="docViewerFileName"></span>
        </div>
        <button class="doc-viewer-close" onclick="DocumentViewer.close()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="doc-viewer-body">
        <div class="doc-viewer-meta">
          <div class="doc-viewer-meta-item">
            <span class="doc-viewer-meta-label">Тип:</span>
            <span class="doc-viewer-meta-value" id="docViewerType"></span>
          </div>
          <div class="doc-viewer-meta-item">
            <span class="doc-viewer-meta-label">Джерело:</span>
            <span class="doc-viewer-meta-value" id="docViewerSource"></span>
          </div>
          <div class="doc-viewer-meta-item">
            <span class="doc-viewer-meta-label">Кейс:</span>
            <span class="doc-viewer-meta-value" id="docViewerCase" style="color: var(--accent);"></span>
          </div>
          <div class="doc-viewer-meta-item">
            <span class="doc-viewer-meta-label">AI Confidence:</span>
            <span class="doc-viewer-meta-value" id="docViewerConfidence"></span>
          </div>
        </div>
        <div class="doc-viewer-content-grid">
          <div class="doc-viewer-preview" id="docViewerPreview"></div>
          <div class="doc-viewer-extracted">
            <div class="extracted-header">
              <h4>AI Extracted Data</h4>
              <span class="extracted-badge" id="extractedConfidenceBadge">—</span>
            </div>
            <div class="extracted-fields" id="extractedFields"></div>
            <div class="extracted-actions">
              <label class="checkbox-label">
                <input type="checkbox" id="extractedDataCorrect">
                <span>Дані коректні</span>
              </label>
              <button id="editExtractedBtn" class="btn btn-sm btn-ghost" onclick="DocumentViewer.editExtracted()">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                Редагувати дані
              </button>
            </div>
            <div class="extracted-comment" style="margin-top: 16px;">
              <label style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Коментар (опціонально):</label>
              <textarea id="verificationComment" placeholder="Додаткові нотатки про верифікацію..." style="width: 100%; min-height: 60px; padding: 8px; border: 1px solid var(--divider); border-radius: var(--radius-sm); background: var(--bg-panel); color: var(--text); font-family: inherit; font-size: 12px; resize: vertical;"></textarea>
            </div>
          </div>
        </div>
        <div class="doc-viewer-actions">
          <button class="btn btn-secondary" onclick="DocumentViewer.download()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Скачати
          </button>
          <button class="btn btn-danger" onclick="DocumentViewer.reject()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
            Відхилити
          </button>
          <button class="btn btn-primary" onclick="DocumentViewer.verify()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            Верифікувати
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- SheetJS Library for Excel preview -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <script>
    // ===== ONBOARDING TIPS SYSTEM =====
    const TipsManager = {
      storageKey: 'imcp_case_detail_tips',
      tips: [],
      currentStep: 0,
      tourMode: false,

      init() {
        this.loadState();
        this.createTips();
        this.createShowTipsButton();
        
        setTimeout(() => {
          if (!this.allTipsDismissed()) {
            this.showInitialTips();
          }
        }, 500);
      },

      loadState() {
        try {
          const saved = localStorage.getItem(this.storageKey);
          this.dismissedTips = saved ? JSON.parse(saved) : {};
        } catch (e) {
          this.dismissedTips = {};
        }
      },

      saveState() {
        try {
          localStorage.setItem(this.storageKey, JSON.stringify(this.dismissedTips));
        } catch (e) {}
      },

      allTipsDismissed() {
        return this.tips.every(tip => this.dismissedTips[tip.id]);
      },

      createTips() {
        this.tips = [
          {
            id: 'tip-nba',
            targetSelector: '.nba-card',
            title: 'Next Best Action',
            description: 'Головна дія, яку потрібно виконати для просування кейсу. Система автоматично визначає наступний крок.',
            position: 'bottom-left',
            arrow: 'top',
            icon: 'bolt'
          },
          {
            id: 'tip-quote',
            targetSelector: '.quote-draft',
            title: 'Quote Draft',
            description: 'Розрахунок ціни для клієнта. Перевірте всі позиції перед підтвердженням.',
            position: 'bottom-left',
            arrow: 'top',
            icon: 'dollar'
          },
          {
            id: 'tip-context',
            targetSelector: '.context-sidebar',
            title: 'Контекстна інформація',
            description: 'Всі дані про вантаж, маршрут, клієнта та ризики зібрані в бічній панелі для швидкого доступу.',
            position: 'left',
            arrow: 'right',
            icon: 'info'
          },
          {
            id: 'tip-timeline',
            targetSelector: '#timeline',
            title: 'Історія подій',
            description: 'Хронологія всіх дій: системних, людських та AI. Допомагає зрозуміти, що відбувалося з кейсом.',
            position: 'inside-top',
            arrow: 'none',
            icon: 'clock'
          }
        ];
      },

      createShowTipsButton() {
        const btn = document.createElement('button');
        btn.className = 'show-tips-btn';
        btn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
          Підказки
        `;
        btn.onclick = () => this.startTour();
        document.body.appendChild(btn);
      },

      showInitialTips() {
        const firstActiveTip = this.tips.find(tip => !this.dismissedTips[tip.id]);
        if (firstActiveTip) {
          this.showTip(firstActiveTip, false);
        }
      },

      showTip(tipConfig, isTour = false) {
        const target = document.querySelector(tipConfig.targetSelector);
        if (!target) return;

        this.hideAllTips();

        const tip = document.createElement('div');
        tip.className = `tip arrow-${tipConfig.arrow}`;
        tip.dataset.tipId = tipConfig.id;

        const iconSvg = this.getIcon(tipConfig.icon);
        const stepIndicator = isTour ? this.getStepIndicator() : '';

        tip.innerHTML = `
          <button class="tip-close" onclick="TipsManager.dismissTip('${tipConfig.id}')">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
          <div class="tip-content">
            <div class="tip-icon">${iconSvg}</div>
            <div class="tip-text">
              <div class="tip-title">${tipConfig.title}</div>
              <div class="tip-description">${tipConfig.description}</div>
              ${isTour ? `
                <div class="tip-actions">
                  ${this.currentStep > 0 ? '<button class="tip-btn tip-btn-secondary" onclick="TipsManager.prevStep()">← Назад</button>' : ''}
                  ${this.currentStep < this.tips.length - 1 
                    ? '<button class="tip-btn tip-btn-primary" onclick="TipsManager.nextStep()">Далі →</button>'
                    : '<button class="tip-btn tip-btn-primary" onclick="TipsManager.endTour()">Готово ✓</button>'}
                </div>
              ` : ''}
              ${stepIndicator}
            </div>
          </div>
        `;

        document.body.appendChild(tip);
        this.positionTip(tip, target, tipConfig.position);

        if (isTour) {
          target.classList.add('tip-highlight');
        }
      },

      positionTip(tip, target, position) {
        const targetRect = target.getBoundingClientRect();
        const tipRect = tip.getBoundingClientRect();
        let top, left;

        switch (position) {
          case 'bottom-right':
            top = targetRect.bottom + 12;
            left = targetRect.right - tipRect.width;
            break;
          case 'bottom-left':
            top = targetRect.bottom + 12;
            left = targetRect.left;
            break;
          case 'inside-top':
            top = targetRect.top + 60;
            left = targetRect.left + 20;
            break;
          case 'right':
            top = targetRect.top;
            left = targetRect.right + 12;
            break;
          case 'left':
            top = targetRect.top;
            left = targetRect.left - tipRect.width - 12;
            break;
          default:
            top = targetRect.bottom + 12;
            left = targetRect.left;
        }

        const padding = 16;
        left = Math.max(padding, Math.min(left, window.innerWidth - tipRect.width - padding));
        top = Math.max(padding, Math.min(top, window.innerHeight - tipRect.height - padding));

        tip.style.position = 'fixed';
        tip.style.top = `${top}px`;
        tip.style.left = `${left}px`;
      },

      getIcon(iconName) {
        const icons = {
          bolt: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
          dollar: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
          info: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
          clock: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
          check: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>'
        };
        return icons[iconName] || icons.info;
      },

      getStepIndicator() {
        if (!this.tourMode) return '';
        const dots = this.tips.map((_, i) => 
          `<span class="tip-step-dot ${i === this.currentStep ? 'active' : ''}"></span>`
        ).join('');
        return `<div class="tip-step"><div class="tip-step-dots">${dots}</div><span>${this.currentStep + 1} з ${this.tips.length}</span></div>`;
      },

      dismissTip(tipId) {
        const tip = document.querySelector(`[data-tip-id="${tipId}"]`);
        if (tip) {
          tip.classList.add('hiding');
          setTimeout(() => tip.remove(), 300);
        }
        this.dismissedTips[tipId] = true;
        this.saveState();
        document.querySelectorAll('.tip-highlight').forEach(el => el.classList.remove('tip-highlight'));
        if (this.tourMode) this.endTour();
      },

      hideAllTips() {
        document.querySelectorAll('.tip').forEach(tip => tip.remove());
        document.querySelectorAll('.tip-highlight').forEach(el => el.classList.remove('tip-highlight'));
      },

      startTour() {
        this.tourMode = true;
        this.currentStep = 0;
        
        let overlay = document.querySelector('.tips-overlay');
        if (!overlay) {
          overlay = document.createElement('div');
          overlay.className = 'tips-overlay';
          overlay.onclick = () => this.endTour();
          document.body.appendChild(overlay);
        }
        overlay.classList.add('active');
        this.showCurrentTourStep();
      },

      showCurrentTourStep() {
        if (this.currentStep >= 0 && this.currentStep < this.tips.length) {
          this.showTip(this.tips[this.currentStep], true);
          const target = document.querySelector(this.tips[this.currentStep].targetSelector);
          if (target) target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      },

      nextStep() {
        document.querySelectorAll('.tip-highlight').forEach(el => el.classList.remove('tip-highlight'));
        this.currentStep++;
        if (this.currentStep < this.tips.length) {
          this.showCurrentTourStep();
        } else {
          this.endTour();
        }
      },

      prevStep() {
        document.querySelectorAll('.tip-highlight').forEach(el => el.classList.remove('tip-highlight'));
        if (this.currentStep > 0) {
          this.currentStep--;
          this.showCurrentTourStep();
        }
      },

      endTour() {
        this.tourMode = false;
        this.hideAllTips();
        const overlay = document.querySelector('.tips-overlay');
        if (overlay) overlay.classList.remove('active');
      },

      resetAllTips() {
        this.dismissedTips = {};
        this.saveState();
        this.showInitialTips();
      }
    };

    // ===== STATIC HELP SYSTEM =====
    const HelpManager = {
      activePopup: null,
      activeTrigger: null,

      helpContent: {
        'case-header': {
          title: 'Заголовок кейсу',
          icon: 'folder',
          content: `
            <p>Основна інформація про кейс:</p>
            <ul>
              <li><strong>Case ID</strong> — унікальний номер</li>
              <li><strong>Статус</strong> — поточний стан</li>
              <li><strong>SLA</strong> — час до дедлайну</li>
              <li><strong>Owner</strong> — відповідальний менеджер</li>
            </ul>
          `
        },
        'nba-section': {
          title: 'Next Best Action (NBA)',
          icon: 'bolt',
          content: `
            <p>Система автоматично визначає наступну дію для просування кейсу.</p>
            <p><strong>Кнопки дій:</strong></p>
            <ul>
              <li><strong>Approve</strong> — підтвердити без змін</li>
              <li><strong>Edit & Approve</strong> — редагувати та підтвердити</li>
              <li><strong>Reject</strong> — відхилити з причиною</li>
            </ul>
          `
        },
        'quote-section': {
          title: 'Quote Draft',
          icon: 'dollar',
          content: `
            <p>Калькуляція вартості перевезення для клієнта.</p>
            <ul>
              <li><strong>Base cost</strong> — собівартість послуг</li>
              <li><strong>Margin</strong> — маржа компанії</li>
              <li><strong>Assumptions</strong> — умови розрахунку</li>
              <li><strong>Validity</strong> — термін дії ціни</li>
            </ul>
          `
        },
        'documents-section': {
          title: 'Документи кейсу',
          icon: 'file',
          content: `
            <p>Документи, прикріплені до кейсу. AI автоматично обробляє та витягує дані.</p>
            <p><strong>Статуси документів (core):</strong></p>
            <ul>
              <li>🔵 <strong>UPLOADED</strong> — файл завантажено, чекає обробки/верифікації</li>
              <li>🟡 <strong>PROCESSING</strong> — AI обробляє документ</li>
              <li>🟢 <strong>VERIFIED</strong> — дані підтверджені</li>
              <li>⚪ <strong>REPLACED</strong> — замінено новою версією</li>
              <li>⚪ <strong>ARCHIVED</strong> — архівовано</li>
            </ul>
            <p style="margin-top: 10px; font-size: 12px; color: var(--text-secondary);">
              <strong>Needs human review</strong> — це не статус. Це похідний прапорець (наприклад, низька впевненість / ризик / невідповідність).
            </p>
            <p style="margin-top: 12px;"><strong>Workflow верифікації:</strong></p>
            <ol style="padding-left: 16px;">
              <li>Натисніть <strong>View</strong> для перегляду</li>
              <li>Перевірте Document Preview та AI Extracted Data</li>
              <li>При необхідності — <strong>Редагувати дані</strong></li>
              <li><strong>Верифікувати</strong> або <strong>Відхилити</strong></li>
            </ol>
            <p style="margin-top: 8px; font-size: 11px; color: var(--text-muted);">⚡ ≥95% confidence → автоматична верифікація</p>
          `
        },
        'approvals-section': {
          title: 'Approvals (Human Approval Gates)',
          icon: 'check',
          content: `
            <p><strong>Approval</strong> — це контрольна точка, де система підготувала чернетку рішення, а людина має прийняти фінальне рішення.</p>
            <ul>
              <li><strong>request_snapshot</strong> — що пропонує система (immutable)</li>
              <li><strong>decision_snapshot</strong> — що підтвердила людина (може відрізнятися)</li>
              <li><strong>decision_comment</strong> — пояснення/причина (опціонально)</li>
            </ul>
            <p style="margin-top: 10px; font-size: 12px; color: var(--text-secondary);">
              Після <strong>APPROVED/REJECTED/CANCELLED</strong> approval не змінюється (immutable decision).
            </p>
          `
        },
        'timeline-section': {
          title: 'Timeline (Історія)',
          icon: 'clock',
          content: `
            <p>Хронологія всіх подій кейсу.</p>
            <p><strong>Типи акторів:</strong></p>
            <ul>
              <li>⚙️ <strong>SYSTEM</strong> — автоматичні дії</li>
              <li>👤 <strong>HUMAN</strong> — дії менеджера</li>
              <li>🤖 <strong>AI</strong> — дії штучного інтелекту</li>
            </ul>
          `
        },
        'cargo-summary': {
          title: 'Cargo Summary',
          icon: 'box',
          content: `
            <p>Характеристики вантажу:</p>
            <ul>
              <li><strong>Packages</strong> — кількість місць</li>
              <li><strong>Dims</strong> — об'єм у кубічних метрах</li>
              <li><strong>Weight</strong> — вага в кілограмах</li>
              <li><strong>Stackable</strong> — чи можна штабелювати</li>
            </ul>
          `
        },
        'route-info': {
          title: 'Route (Маршрут)',
          icon: 'globe',
          content: `
            <p>Інформація про маршрут перевезення:</p>
            <ul>
              <li><strong>Origin</strong> — склад відправлення</li>
              <li><strong>Port</strong> — порт завантаження</li>
              <li><strong>Destination</strong> — місто доставки</li>
              <li><strong>Broker</strong> — хто виконує митне оформлення</li>
            </ul>
          `
        },
        'risk-flags': {
          title: 'Risk Flags',
          icon: 'alert',
          content: `
            <p>Ризики та попередження для кейсу.</p>
            <p><strong>Рівні ризику:</strong></p>
            <ul>
              <li>🔴 <strong>High</strong> — критичний, потребує уваги</li>
              <li>🟡 <strong>Medium</strong> — помірний ризик</li>
              <li>🟢 <strong>Low</strong> — інформаційний</li>
            </ul>
          `
        },
        'required-fields': {
          title: 'Required Fields Checklist',
          icon: 'check',
          content: `
            <p>Чекліст полів, які потрібні для переходу зі state, а також поля, що потребують верифікації.</p>
            <ul>
              <li>✅ filled — поле заповнено</li>
              <li>⚠️ needs verification — поле є, але потрібна перевірка (ризик/невідповідність)</li>
              <li>❌ missing — поле відсутнє і блокує перехід</li>
            </ul>
            <p style="margin-top: 10px; font-size: 12px; color: var(--text-secondary);">
              Це реалізує core-принцип: “UI завжди показує, що блокує перехід”.
            </p>
          `
        },
        'integration-ids': {
          title: 'Integration IDs',
          icon: 'code',
          content: `
            <p>Ідентифікатори в зовнішніх системах:</p>
            <ul>
              <li><strong>1C Request</strong> — номер заявки в 1С</li>
              <li><strong>Marking</strong> — маркування на складі</li>
            </ul>
            <p>Використовуйте для пошуку в інших системах.</p>
            <p style="margin-top: 10px; font-size: 12px; color: var(--text-secondary);">
              У production також показується стан інтеграції (<strong>PENDING/SYNCED/FAILED</strong>) + остання помилка/ретраї.
            </p>
          `
        }
      },

      init() {
        this.bindEvents();
      },

      bindEvents() {
        document.addEventListener('click', (e) => {
          const trigger = e.target.closest('.help-trigger');
          
          if (trigger) {
            e.preventDefault();
            e.stopPropagation();
            const helpId = trigger.dataset.help;
            if (helpId) this.togglePopup(helpId, trigger);
            return;
          }

          if (this.activePopup && !e.target.closest('.help-popup')) {
            this.closePopup();
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.activePopup) {
            this.closePopup();
          }
        });
      },

      togglePopup(helpId, trigger) {
        if (this.activeTrigger === trigger) {
          this.closePopup();
          return;
        }

        this.closePopup();

        const content = this.helpContent[helpId];
        if (!content) return;

        const popup = document.createElement('div');
        popup.className = 'help-popup';
        popup.innerHTML = `
          <div class="help-popup-header">
            <div class="help-popup-icon">${this.getIcon(content.icon)}</div>
            <div class="help-popup-title">${content.title}</div>
          </div>
          <div class="help-popup-content">${content.content}</div>
        `;

        document.body.appendChild(popup);
        this.positionPopup(popup, trigger);

        this.activePopup = popup;
        this.activeTrigger = trigger;
        trigger.classList.add('active');
      },

      positionPopup(popup, trigger) {
        const triggerRect = trigger.getBoundingClientRect();
        const popupRect = popup.getBoundingClientRect();

        let top = triggerRect.bottom + 8;
        let left = triggerRect.left - 10;

        if (left + popupRect.width > window.innerWidth - 16) {
          left = window.innerWidth - popupRect.width - 16;
        }

        if (top + popupRect.height > window.innerHeight - 16) {
          top = triggerRect.top - popupRect.height - 8;
          popup.classList.add('arrow-bottom');
        }

        left = Math.max(16, left);

        popup.style.position = 'fixed';
        popup.style.top = `${top}px`;
        popup.style.left = `${left}px`;
      },

      closePopup() {
        if (this.activePopup) {
          this.activePopup.classList.add('closing');
          setTimeout(() => {
            if (this.activePopup) {
              this.activePopup.remove();
              this.activePopup = null;
            }
          }, 150);
        }
        if (this.activeTrigger) {
          this.activeTrigger.classList.remove('active');
          this.activeTrigger = null;
        }
      },

      getIcon(iconName) {
        const icons = {
          info: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
          bolt: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
          dollar: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
          file: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
          clock: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
          box: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>',
          globe: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>',
          alert: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
          folder: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>',
          code: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>'
        };
        return icons[iconName] || icons.info;
      }
    };

    // ===== DOCUMENT TYPE SCHEMAS =====
    const DOC_TYPE_SCHEMAS = {
      PACKING_LIST: {
        name: 'Packing List',
        fields: [
          { key: 'packages_count', label: 'Кількість місць', type: 'number', required: true },
          { key: 'total_weight_kg', label: 'Загальна вага (кг)', type: 'number', required: true },
          { key: 'volume_cbm', label: "Загальний об'єм (CBM)", type: 'number', required: false },
          { key: 'dimensions', label: 'Розміри (L×W×H см)', type: 'text', required: true },
          { key: 'package_type', label: 'Тип упаковки', type: 'text', required: false }
        ],
        mockValues: { packages_count: '10', total_weight_kg: '255', volume_cbm: '0.222', dimensions: '60×40×50', package_type: 'Картонні коробки' }
      },
      INVOICE: {
        name: 'Invoice',
        fields: [
          { key: 'invoice_number', label: 'Номер інвойсу', type: 'text', required: true },
          { key: 'invoice_date', label: 'Дата', type: 'date', required: true },
          { key: 'amount', label: 'Сума', type: 'currency', required: true },
          { key: 'currency', label: 'Валюта', type: 'select', options: ['USD', 'EUR', 'CNY', 'UAH'], required: true },
          { key: 'supplier', label: 'Постачальник', type: 'text', required: true }
        ],
        mockValues: { invoice_number: 'INV2026-0451', invoice_date: '2026-01-12', amount: '$12,450.00', currency: 'USD', supplier: 'ACME Supplies' }
      },
      CONTRACT: {
        name: 'Contract',
        fields: [
          { key: 'contract_number', label: 'Номер контракту', type: 'text', required: true },
          { key: 'contract_date', label: 'Дата контракту', type: 'date', required: true },
          { key: 'seller', label: 'Продавець', type: 'text', required: true },
          { key: 'buyer', label: 'Покупець', type: 'text', required: true },
          { key: 'incoterms', label: 'Incoterms', type: 'select', options: ['FOB', 'CIF', 'CFR', 'EXW', 'DAP', 'DDP'], required: true },
          { key: 'total_value', label: 'Сума контракту', type: 'currency', required: true }
        ],
        mockValues: { contract_number: 'CT-2026-0451', contract_date: '2026-01-05', seller: 'ACME Supplies Co.', buyer: 'TechImport LLC', incoterms: 'FOB', total_value: '$12,450.00' }
      },
      _DEFAULT: {
        name: 'Document',
        fields: [
          { key: 'doc_type', label: 'Тип документа', type: 'text', required: false },
          { key: 'source', label: 'Джерело', type: 'text', required: false }
        ],
        mockValues: {}
      }
    };

    // ===== DOCUMENT VIEWER =====
    const DocumentViewer = {
      currentDoc: null,
      extractedFields: {},
      currentSchema: null,

      init() {
        document.addEventListener('click', (e) => {
          const btn = e.target.closest('[data-doc-view]');
          if (btn) { e.preventDefault(); e.stopPropagation(); this.open(btn); }
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.isOpen()) this.close();
        });
      },

      open(button) {
        const modal = document.getElementById('docViewerModal');
        if (!modal) return;

        this.currentDoc = {
          name: button.dataset.docName || '',
          type: button.dataset.docType || '',
          source: button.dataset.docSource || '',
          case: button.dataset.docCase || '',
          confidence: button.dataset.docConfidence || '',
          file: button.dataset.docFile || '',
          status: button.dataset.docStatus || 'UPLOADED'
        };

        document.getElementById('docViewerFileName').textContent = this.currentDoc.name;
        document.getElementById('docViewerType').textContent = this.currentDoc.type;
        document.getElementById('docViewerSource').textContent = this.currentDoc.source;
        document.getElementById('docViewerCase').textContent = this.currentDoc.case;
        
        const confidenceEl = document.getElementById('docViewerConfidence');
        confidenceEl.textContent = this.currentDoc.confidence ? `${this.currentDoc.confidence}%` : '—';

        this.renderPreview();
        this.renderExtractedData();
        this.updateActionsForStatus();
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
      },

      close() {
        const modal = document.getElementById('docViewerModal');
        if (modal) modal.style.display = 'none';
        document.body.style.overflow = '';
        this.currentDoc = null;
      },

      isOpen() {
        const modal = document.getElementById('docViewerModal');
        return modal && modal.style.display !== 'none';
      },

      updateActionsForStatus() {
        const isVerified = this.currentDoc.status === 'VERIFIED';
        const isProcessing = this.currentDoc.status === 'PROCESSING';
        const isReadOnly = isVerified || isProcessing;

        const verifyBtn = document.querySelector('.doc-viewer-actions .btn-primary');
        const rejectBtn = document.querySelector('.doc-viewer-actions .btn-danger');
        const editBtn = document.getElementById('editExtractedBtn');
        const checkboxLabel = document.querySelector('.extracted-actions .checkbox-label');
        const commentSection = document.querySelector('.extracted-comment');

        if (verifyBtn) verifyBtn.style.display = isReadOnly ? 'none' : 'flex';
        if (rejectBtn) rejectBtn.style.display = isReadOnly ? 'none' : 'flex';
        if (editBtn) editBtn.style.display = isReadOnly ? 'none' : 'flex';
        if (checkboxLabel) checkboxLabel.style.display = isReadOnly ? 'none' : 'flex';
        if (commentSection) commentSection.style.display = isReadOnly ? 'none' : 'block';

        const extractedHeader = document.querySelector('.extracted-header h4');
        if (extractedHeader) {
          const existingStatus = extractedHeader.querySelector('.status-indicator');
          if (existingStatus) existingStatus.remove();

          if (isVerified) {
            const badge = document.createElement('span');
            badge.className = 'status-indicator';
            badge.style.cssText = 'display: inline-flex; align-items: center; gap: 4px; margin-left: 8px; padding: 2px 8px; background: var(--success-bg); color: var(--success-text); border-radius: var(--radius-sm); font-size: 10px; font-weight: 500;';
            badge.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> VERIFIED';
            extractedHeader.appendChild(badge);
          }
        }

        if (isProcessing) {
          document.getElementById('extractedFields').innerHTML = '<div style="text-align: center; padding: 24px; color: var(--text-muted);"><div style="font-size: 14px;">AI обробляє документ...</div></div>';
        }
      },

      async renderPreview() {
        const preview = document.getElementById('docViewerPreview');
        if (!preview || !this.currentDoc) return;

        preview.innerHTML = '<div class="preview-info"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><div style="font-size: 14px; margin-top: 12px;">Завантаження...</div></div>';

        const fileName = this.currentDoc.file || this.currentDoc.name;
        const isExcel = this.currentDoc.name.endsWith('.xlsx') || this.currentDoc.name.endsWith('.xls');
        const isPdf = this.currentDoc.name.endsWith('.pdf') || (fileName && fileName.endsWith('.pdf'));

        try {
          if (isExcel && fileName) {
            await this.renderExcelFile(preview, fileName);
          } else if (isPdf && fileName) {
            preview.innerHTML = `<iframe src="${encodeURI(fileName)}" style="width: 100%; height: 100%; min-height: 500px; border: none; border-radius: var(--radius-sm);" title="PDF Preview"></iframe>`;
          } else {
            this.renderFallbackPreview(preview);
          }
        } catch (error) {
          this.renderFallbackPreview(preview);
        }
      },

      renderFallbackPreview(container) {
        container.innerHTML = `<div class="preview-info"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><div style="font-size: 14px;">${this.currentDoc.name}</div><div style="font-size: 12px; color: var(--text-muted);">Для перегляду завантажте файл</div></div>`;
      },

      async renderExcelFile(container, fileName) {
        if (typeof XLSX === 'undefined') throw new Error('SheetJS not loaded');
        const response = await fetch(fileName);
        if (!response.ok) throw new Error('Failed to load');
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const html = XLSX.utils.sheet_to_html(workbook.Sheets[workbook.SheetNames[0]], { id: 'excel-table', editable: false });
        container.innerHTML = `<div style="overflow-x: auto;"><style>#excel-table{width:100%;border-collapse:collapse;font-size:13px;}#excel-table th{background:var(--bg-hover);font-weight:600;padding:8px 12px;border-bottom:2px solid var(--divider);}#excel-table td{padding:8px 12px;border-bottom:1px solid var(--divider);}</style>${html}</div>`;
      },

      renderExtractedData() {
        const extractedContainer = document.getElementById('extractedFields');
        const confidenceBadge = document.getElementById('extractedConfidenceBadge');
        const confidence = parseInt(this.currentDoc.confidence) || 0;
        const isProcessing = this.currentDoc.status === 'PROCESSING';

        if (isProcessing || !this.currentDoc.confidence) {
          confidenceBadge.style.display = 'none';
        } else {
          confidenceBadge.style.display = 'inline-flex';
          confidenceBadge.textContent = `${confidence}% confidence`;
          confidenceBadge.className = 'extracted-badge';
          if (confidence >= 95) confidenceBadge.classList.add('high');
          else if (confidence >= 85) confidenceBadge.classList.add('medium');
          else confidenceBadge.classList.add('low');
        }

        this.currentSchema = DOC_TYPE_SCHEMAS[this.currentDoc.type] || DOC_TYPE_SCHEMAS._DEFAULT;
        this.extractedFields = {};
        this.currentSchema.fields.forEach(field => {
          this.extractedFields[field.label] = this.currentSchema.mockValues[field.key] || '';
        });

        extractedContainer.innerHTML = Object.entries(this.extractedFields).map(([label, value]) => {
          const schemaField = this.currentSchema.fields.find(f => f.label === label);
          const isRequired = schemaField ? schemaField.required : false;
          return `<div class="extracted-field"><div class="extracted-field-label">${label}${isRequired ? '<span style="color: var(--danger); margin-left: 2px;">*</span>' : ''}</div><div class="extracted-field-value">${value}</div></div>`;
        }).join('');
      },

      download() {
        if (!this.currentDoc || !this.currentDoc.file) { alert('Файл недоступний'); return; }
        const link = document.createElement('a');
        link.href = this.currentDoc.file;
        link.download = this.currentDoc.name;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      },

      verify() {
        const checkbox = document.getElementById('extractedDataCorrect');
        if (!checkbox.checked) { alert('Підтвердіть коректність даних'); return; }
        // PoC: simulate status transition + audit event
        this.currentDoc.status = 'VERIFIED';
        TimelineManager?.addEvent?.({
          actorType: 'HUMAN',
          actorLabel: 'HUMAN (Іван П.)',
          eventType: 'DOC_VERIFIED',
          details: `${this.currentDoc.type} • ${this.currentDoc.name}`
        });

        // Update list badge if exists
        const btn = document.querySelector(`[data-doc-view][data-doc-name="${CSS.escape(this.currentDoc.name)}"]`);
        const item = btn ? btn.closest('.doc-item') : null;
        if (item) {
          // Best-effort: replace any existing badge container with VERIFIED badge
          const existingBadges = item.querySelectorAll('.badge');
          existingBadges.forEach(b => b.remove());
          const verifiedBadge = document.createElement('span');
          verifiedBadge.className = 'badge badge-success';
          verifiedBadge.textContent = 'VERIFIED';
          item.insertBefore(verifiedBadge, item.querySelector('.doc-actions'));
        }

        alert(`✅ Документ "${this.currentDoc.name}" верифіковано! Подію додано в Timeline.`);
        this.close();
      },

      reject() {
        document.getElementById('rejectDocName').textContent = this.currentDoc.name;
        document.getElementById('rejectReasonInput').value = '';
        document.getElementById('rejectReasonModal').style.display = 'flex';
      },

      cancelReject() { document.getElementById('rejectReasonModal').style.display = 'none'; },

      confirmReject() {
        const reason = document.getElementById('rejectReasonInput').value.trim();
        if (!reason) { alert('Вкажіть причину відхилення'); return; }
        alert(`❌ Документ "${this.currentDoc.name}" відхилено.\nПричина: ${reason}`);
        this.cancelReject();
        this.close();
      },

      editExtracted() {
        document.getElementById('editDocName').textContent = this.currentDoc.name;
        const fieldsContainer = document.getElementById('editExtractedFields');
        fieldsContainer.innerHTML = this.currentSchema.fields.map(field => {
          const value = this.extractedFields[field.label] || '';
          return `<div style="margin-bottom: 16px;"><label style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">${field.label}${field.required ? '<span style="color: var(--danger);">*</span>' : ''}</label><input type="text" value="${value}" data-field-label="${field.label}" style="width: 100%; padding: 8px 12px; border: 1px solid var(--divider); border-radius: var(--radius-sm); background: var(--bg-panel); color: var(--text); font-size: 13px;" ${field.required ? 'required' : ''}/></div>`;
        }).join('');
        document.getElementById('editExtractedModal').style.display = 'flex';
      },

      cancelEdit() { document.getElementById('editExtractedModal').style.display = 'none'; },

      saveEdited() {
        const inputs = document.querySelectorAll('#editExtractedFields input');
        inputs.forEach(input => { this.extractedFields[input.dataset.fieldLabel] = input.value; });
        const extractedContainer = document.getElementById('extractedFields');
        extractedContainer.innerHTML = Object.entries(this.extractedFields).map(([label, value]) => {
          const schemaField = this.currentSchema.fields.find(f => f.label === label);
          return `<div class="extracted-field"><div class="extracted-field-label">${label}${schemaField?.required ? '<span style="color: var(--danger);">*</span>' : ''}</div><div class="extracted-field-value">${value}</div></div>`;
        }).join('');
        this.cancelEdit();
        alert('Дані збережено!');
      }
    };

    // ===== UPLOAD MODAL =====
    const UploadModal = {
      selectedFiles: [],
      dropZone: null,
      fileInput: null,
      caseId: 'F1-SEA-2026-02451', // Current case ID for case-detail page

      init() {
        const modal = document.getElementById('uploadModal');
        if (!modal) return;

        // Bind header button
        const uploadBtn = document.querySelector('[data-upload-trigger]');
        if (uploadBtn) {
          uploadBtn.onclick = (e) => {
            e.preventDefault();
            this.open();
          };
        }

        // Get elements
        this.dropZone = document.getElementById('uploadDropZone');
        this.fileInput = document.getElementById('uploadFileInput');

        if (!this.dropZone || !this.fileInput) return;

        // Click to select files
        this.dropZone.onclick = () => this.fileInput.click();

        // File input change
        this.fileInput.onchange = (e) => {
          this.handleFiles(Array.from(e.target.files));
        };

        // Drag and drop
        this.dropZone.ondragover = (e) => {
          e.preventDefault();
          this.dropZone.classList.add('drag-over');
        };

        this.dropZone.ondragleave = () => {
          this.dropZone.classList.remove('drag-over');
        };

        this.dropZone.ondrop = (e) => {
          e.preventDefault();
          this.dropZone.classList.remove('drag-over');
          const files = Array.from(e.dataTransfer.files);
          this.handleFiles(files);
        };

        // ESC to close
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.isOpen()) {
            this.close();
          }
        });
      },

      open() {
        const modal = document.getElementById('uploadModal');
        if (modal) {
          modal.style.display = 'block';
          document.body.style.overflow = 'hidden';
          this.selectedFiles = [];
          this.renderFiles();
        }
      },

      close() {
        const modal = document.getElementById('uploadModal');
        if (modal) {
          modal.style.display = 'none';
          document.body.style.overflow = '';
          this.selectedFiles = [];
          if (this.fileInput) this.fileInput.value = '';
          this.renderFiles();
          // Reset form
          const docTypeSelect = document.getElementById('uploadDocTypeSelect');
          if (docTypeSelect) docTypeSelect.value = '';
        }
      },

      isOpen() {
        const modal = document.getElementById('uploadModal');
        return modal && modal.style.display !== 'none';
      },

      handleFiles(files) {
        const validFiles = files.filter(file => {
          const validExtensions = ['.pdf', '.xlsx', '.xls', '.docx', '.doc', '.png', '.jpg', '.jpeg'];
          const extension = '.' + file.name.split('.').pop().toLowerCase();
          if (!validExtensions.includes(extension)) {
            alert(`Файл "${file.name}" має непідтримуваний формат. Підтримуються: PDF, XLSX, DOCX, PNG, JPG`);
            return false;
          }
          const maxSize = 10 * 1024 * 1024;
          if (file.size > maxSize) {
            alert(`Файл "${file.name}" занадто великий (${(file.size / 1024 / 1024).toFixed(2)}MB). Максимальний розмір: 10MB`);
            return false;
          }
          return true;
        });

        validFiles.forEach(file => {
          if (!this.selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
            this.selectedFiles.push(file);
          }
        });

        this.renderFiles();
      },

      removeFile(index) {
        this.selectedFiles.splice(index, 1);
        this.renderFiles();
      },

      renderFiles() {
        const preview = document.getElementById('uploadFilesPreview');
        const list = document.getElementById('uploadFilesList');

        if (!preview || !list) return;

        if (this.selectedFiles.length === 0) {
          preview.style.display = 'none';
          return;
        }

        preview.style.display = 'block';
        list.innerHTML = this.selectedFiles.map((file, index) => {
          const size = file.size < 1024 
            ? `${file.size} B` 
            : file.size < 1024 * 1024 
            ? `${(file.size / 1024).toFixed(1)} KB` 
            : `${(file.size / 1024 / 1024).toFixed(2)} MB`;
          
          const extension = '.' + file.name.split('.').pop().toLowerCase();
          const icon = extension === '.pdf' ? '📄' : 
                      ['.xlsx', '.xls'].includes(extension) ? '📊' :
                      ['.docx', '.doc'].includes(extension) ? '📝' :
                      ['.png', '.jpg', '.jpeg'].includes(extension) ? '🖼️' : '📎';

          return `
            <div class="upload-file-item">
              <div class="upload-file-info">
                <div class="upload-file-icon">${icon}</div>
                <div class="upload-file-details">
                  <div class="upload-file-name">${file.name}</div>
                  <div class="upload-file-size">${size}</div>
                </div>
              </div>
              <button class="upload-file-remove" onclick="UploadModal.removeFile(${index})" title="Видалити">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
          `;
        }).join('');
      },

      upload() {
        if (this.selectedFiles.length === 0) {
          alert('Будь ласка, виберіть файли для завантаження');
          return;
        }

        const docTypeSelect = document.getElementById('uploadDocTypeSelect');
        const docType = docTypeSelect ? docTypeSelect.value : '';
        const fileNames = this.selectedFiles.map(f => f.name).join(', ');
        const docTypeText = docType ? ` (${docType})` : '';

        console.log('Uploading files:', {
          files: this.selectedFiles.map(f => ({ name: f.name, size: f.size })),
          case: this.caseId,
          docType: docType || 'AUTO'
        });

        // Show loading state
        const uploadBtn = document.querySelector('.upload-modal-actions .btn-primary');
        const originalText = uploadBtn.innerHTML;
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="animation: spin 1s linear infinite;"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg> Завантаження...';

        // Simulate upload delay
        setTimeout(() => {
          this.showToast(`Успішно завантажено ${this.selectedFiles.length} ${this.selectedFiles.length === 1 ? 'файл' : 'файлів'}`);
          this.close();
          uploadBtn.disabled = false;
          uploadBtn.innerHTML = originalText;

          setTimeout(() => {
            alert(`Демо: ${this.selectedFiles.length} файл(ів) "${fileNames}" завантажено для кейсу ${this.caseId}${docTypeText}.\n\nВ реальній системі:\n- Файли завантажаться на сервер\n- documents.status = UPLOADED\n- n8n тригер → AI обробка\n- status → PROCESSING → VERIFIED (якщо confidence ≥ threshold) або назад в UPLOADED + прапорець "needs human review"\n- Документи з'являться в списку`);
          }, 300);
        }, 1500);
      },

      showToast(message) {
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          bottom: 24px;
          right: 24px;
          background: var(--success-bg, #10b981);
          color: white;
          padding: 12px 20px;
          border-radius: var(--radius-md, 8px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
          z-index: 10000;
          font-size: 14px;
          animation: slideIn 0.3s ease-out;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.style.animation = 'slideOut 0.3s ease-out';
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }
    };

    // ===== TIMELINE MANAGER (append-only event log in UI) =====
    const TimelineManager = {
      listEl: null,

      init() {
        this.listEl = document.getElementById('timelineList');
      },

      addEvent({ actorType, actorLabel, eventType, details }) {
        if (!this.listEl) return;
        const item = document.createElement('div');
        item.className = 'timeline-item';

        const markerClass =
          actorType === 'HUMAN' ? 'human' :
          actorType === 'AI' ? 'ai' :
          actorType === 'INTEGRATION' ? 'system' :
          'system';

        const iconSvg =
          actorType === 'HUMAN'
            ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>'
            : actorType === 'AI'
            ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5"/></svg>'
            : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/></svg>';

        item.innerHTML = `
          <div class="timeline-marker ${markerClass}">
            ${iconSvg}
          </div>
          <div class="timeline-content">
            <div class="timeline-header">
              <span class="timeline-actor">${actorLabel}</span>
              <span class="timeline-time">щойно</span>
            </div>
            <div class="timeline-event">${eventType}</div>
            <div class="timeline-details">${details || ''}</div>
          </div>
        `;

        this.listEl.insertBefore(item, this.listEl.firstChild);
      }
    };

    // ===== REQUIRED FIELDS CHECKLIST (PoC) =====
    const RequiredFieldsManager = {
      el: null,
      init() {
        this.el = document.getElementById('requiredFieldsCardBody');
      },
      setDimensionsNeedsVerification(isNeedsVerification) {
        if (!this.el) return;
        const rows = Array.from(this.el.querySelectorAll('.required-field-row'));
        const dimsRow = rows.find(r => (r.textContent || '').includes('Dimensions'));
        if (!dimsRow) return;
        const statusEl = dimsRow.querySelector('.required-field-status');
        if (!statusEl) return;
        if (isNeedsVerification) {
          statusEl.className = 'required-field-status warn';
          statusEl.textContent = '⚠️ needs verification';
        } else {
          statusEl.className = 'required-field-status ok';
          statusEl.textContent = '✅ verified';
        }
      }
    };

    // ===== APPROVAL MANAGER (Draft-first + immutable decision) =====
    const ApprovalManager = {
      approval: {
        id: 'APR-QUOTE-0001',
        type: 'QUOTE_APPROVAL',
        status: 'PENDING',
        requested_by: 'SYSTEM',
        requested_at: '12:10 сьогодні',
        request_snapshot: {
          quote_version: 1,
          base_cost_usd: 2450,
          margin_usd: 350,
          total_usd: 2800,
          validity_days: 7,
          assumptions: ['Stackable cargo', 'No dangerous goods', 'Standard container load', 'Yiwu → Shenzhen → Odessa → Kyiv'],
          risks: ['Dimensions not verified by warehouse yet']
        },
        decision_snapshot: null,
        decision_comment: null
      },

      init() {
        const openDetails = () => this.openDetails();
        const openFromList = () => this.openDetails();

        const openBtn = document.getElementById('openApprovalDetailsBtn');
        if (openBtn) openBtn.onclick = openDetails;

        const openFromListBtn = document.getElementById('openApprovalFromListBtn');
        if (openFromListBtn) openFromListBtn.onclick = openFromList;

        const nbaApproveBtn = document.getElementById('nbaApproveBtn');
        const nbaEditBtn = document.getElementById('nbaEditApproveBtn');
        const nbaRejectBtn = document.getElementById('nbaRejectBtn');

        if (nbaApproveBtn) nbaApproveBtn.onclick = () => this.openConfirm();
        if (nbaEditBtn) nbaEditBtn.onclick = () => this.openEdit();
        if (nbaRejectBtn) nbaRejectBtn.onclick = () => this.openReject();

        this.syncUi();
      },

      isPending() {
        return this.approval.status === 'PENDING';
      },

      syncUi() {
        const idEl = document.getElementById('nbaApprovalId');
        if (idEl) idEl.textContent = this.approval.id;

        const requestedAt = document.getElementById('approvalRequestedAt');
        if (requestedAt) requestedAt.textContent = this.approval.requested_at;

        const countEl = document.getElementById('pendingApprovalsCount');
        if (countEl) countEl.textContent = this.isPending() ? '1 PENDING' : '0 PENDING';

        // disable actions if decided
        ['nbaApproveBtn', 'nbaEditApproveBtn', 'nbaRejectBtn'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.disabled = !this.isPending();
        });

        // Update approval list badge
        const listBadge = document.querySelector('#approvals .badge.badge-warning');
        if (listBadge) listBadge.textContent = this.isPending() ? 'PENDING' : this.approval.status;
      },

      openDetails() {
        const modal = document.getElementById('approvalModal');
        if (!modal) return;
        document.getElementById('approvalTypeTitle').textContent = this.approval.type;
        document.getElementById('approvalIdValue').textContent = this.approval.id;
        document.getElementById('approvalStatusValue').textContent = this.approval.status;
        document.getElementById('approvalRequestedValue').textContent = `${this.approval.requested_by} • ${this.approval.requested_at}`;
        document.getElementById('approvalRequestSnapshot').textContent = JSON.stringify(this.approval.request_snapshot, null, 2);
        document.getElementById('approvalDecisionComment').value = this.approval.decision_comment || '';
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
      },

      closeDetails() {
        const modal = document.getElementById('approvalModal');
        if (modal) modal.style.display = 'none';
        document.body.style.overflow = '';
      },

      openConfirm() {
        if (!this.isPending()) return UploadModal.showToast('Approval вже вирішено');
        const modal = document.getElementById('approvalConfirmModal');
        if (!modal) return;
        document.getElementById('confirmApprovalTitle').textContent = this.approval.type;
        modal.style.display = 'flex';
      },

      closeConfirm() {
        const modal = document.getElementById('approvalConfirmModal');
        if (modal) modal.style.display = 'none';
      },

      openReject() {
        if (!this.isPending()) return UploadModal.showToast('Approval вже вирішено');
        const modal = document.getElementById('approvalRejectModal');
        if (!modal) return;
        document.getElementById('rejectApprovalTitle').textContent = this.approval.type;
        document.getElementById('approvalRejectReasonInput').value = '';
        modal.style.display = 'flex';
      },

      closeReject() {
        const modal = document.getElementById('approvalRejectModal');
        if (modal) modal.style.display = 'none';
      },

      openEdit() {
        if (!this.isPending()) return UploadModal.showToast('Approval вже вирішено');
        const modal = document.getElementById('quoteEditModal');
        if (!modal) return;
        modal.style.display = 'flex';
      },

      closeEdit() {
        const modal = document.getElementById('quoteEditModal');
        if (modal) modal.style.display = 'none';
      },

      confirmApprove() {
        if (!this.isPending()) return;
        this.approve({ hasEdits: false });
      },

      saveEditAndApprove() {
        if (!this.isPending()) return;
        const base = parseFloat(document.getElementById('editQuoteBaseCost').value || '0');
        const margin = parseFloat(document.getElementById('editQuoteMargin').value || '0');
        const validity = parseInt(document.getElementById('editQuoteValidity').value || '0', 10);
        const assumptionsRaw = (document.getElementById('editQuoteAssumptions').value || '').split('\n').map(s => s.trim()).filter(Boolean);

        const snapshot = {
          ...this.approval.request_snapshot,
          base_cost_usd: base,
          margin_usd: margin,
          total_usd: base + margin,
          validity_days: validity,
          assumptions: assumptionsRaw
        };
        this.approve({ hasEdits: true, decisionSnapshot: snapshot });
      },

      approve({ hasEdits, decisionSnapshot }) {
        this.closeConfirm();
        this.closeReject();
        this.closeEdit();

        const comment = (document.getElementById('approvalDecisionComment')?.value || '').trim() || null;

        this.approval.status = 'APPROVED';
        this.approval.decision_comment = comment;
        this.approval.decision_snapshot = decisionSnapshot || this.approval.request_snapshot;

        TimelineManager.addEvent({
          actorType: 'HUMAN',
          actorLabel: 'HUMAN (Іван П.)',
          eventType: 'APPROVAL_APPROVED',
          details: `${this.approval.type} • has_edits=${hasEdits ? 'true' : 'false'}`
        });

        // Simulate workflow reaction (system updates state)
        this.setCaseState('QUOTE_SENT');
        TimelineManager.addEvent({
          actorType: 'SYSTEM',
          actorLabel: 'SYSTEM',
          eventType: 'STATE_CHANGED',
          details: 'QUOTE_APPROVAL_PENDING → QUOTE_SENT'
        });
        TimelineManager.addEvent({
          actorType: 'SYSTEM',
          actorLabel: 'SYSTEM',
          eventType: 'EMAIL_SENT',
          details: 'Quote sent to client'
        });

        UploadModal.showToast('Approval підтверджено');
        this.closeDetails();
        this.syncUi();
      },

      confirmReject() {
        if (!this.isPending()) return;
        const reason = (document.getElementById('approvalRejectReasonInput').value || '').trim();
        if (!reason) return alert('Вкажіть причину відхилення');

        const comment = (document.getElementById('approvalDecisionComment')?.value || '').trim() || null;

        this.approval.status = 'REJECTED';
        this.approval.decision_comment = comment || reason;
        this.approval.decision_snapshot = this.approval.request_snapshot;

        TimelineManager.addEvent({
          actorType: 'HUMAN',
          actorLabel: 'HUMAN (Іван П.)',
          eventType: 'APPROVAL_REJECTED',
          details: `${this.approval.type} • reason: ${reason}`
        });

        this.setCaseState('QUOTE_READY');
        TimelineManager.addEvent({
          actorType: 'SYSTEM',
          actorLabel: 'SYSTEM',
          eventType: 'STATE_CHANGED',
          details: 'QUOTE_APPROVAL_PENDING → QUOTE_READY'
        });

        UploadModal.showToast('Approval відхилено');
        this.closeReject();
        this.closeDetails();
        this.syncUi();
      },

      setCaseState(newState) {
        const stateBadge = document.getElementById('caseStateBadge');
        if (stateBadge) {
          stateBadge.textContent = newState;
          stateBadge.className = 'status-badge ' + (
            newState.endsWith('_PENDING') ? 'status-pending' :
            newState.endsWith('_READY') ? 'status-ready' :
            newState.startsWith('WAITING_') ? 'status-waiting' :
            'status-open'
          );
        }

        this.updateNbaForState(newState);
      },

      updateNbaForState(state) {
        const indicator = document.querySelector('.nba-indicator');
        const title = document.querySelector('.nba-title');
        const list = document.querySelector('.nba-description ul');
        const risk = document.querySelector('.nba-risk');

        if (!indicator || !title || !list) return;

        if (state === 'QUOTE_SENT') {
          indicator.style.background = '#F59E0B';
          title.textContent = 'Очікуємо підтвердження клієнта (WAITING_CLIENT_CONFIRMATION)';
          list.innerHTML = `
            <li>Ціну відправлено клієнту</li>
            <li>Очікуємо відповідь (YES/NO)</li>
            <li>Якщо немає відповіді — зробіть follow-up</li>
          `;
          if (risk) risk.style.display = 'none';
        } else if (state === 'QUOTE_READY') {
          indicator.style.background = '#3B82F6';
          title.textContent = 'Перерахувати/уточнити калькуляцію (QUOTE_READY)';
          list.innerHTML = `
            <li>Approval відхилено — потрібно уточнити дані/умови</li>
            <li>Перевірте габарити та припущення</li>
            <li>Після перерахунку система створить новий approval</li>
          `;
          if (risk) risk.style.display = 'flex';
        } else {
          // default stays as initial QUOTE_APPROVAL_PENDING
          indicator.style.background = '#EF4444';
          if (risk) risk.style.display = 'flex';
        }
      }
    };

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      TipsManager.init();
      HelpManager.init();
      DocumentViewer.init();
      UploadModal.init();
      TimelineManager.init();
      RequiredFieldsManager.init();
      ApprovalManager.init();
    });
  </script>

  <!-- Upload Modal -->
  <div id="uploadModal" class="upload-modal" style="display: none;">
    <div class="upload-modal-overlay" onclick="UploadModal.close()"></div>
    <div class="upload-modal-content" onclick="event.stopPropagation()">
      <div class="upload-modal-header">
        <h3>Завантажити документ</h3>
        <button class="upload-modal-close" onclick="UploadModal.close()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="upload-modal-body">
        <!-- Drag and Drop Zone -->
        <div id="uploadDropZone" class="upload-drop-zone">
          <input type="file" id="uploadFileInput" multiple accept=".pdf,.xlsx,.xls,.docx,.doc,.png,.jpg,.jpeg" style="display: none;">
          <div class="upload-drop-content">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--accent); margin-bottom: 12px;">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="12" y1="18" x2="12" y2="12"/>
              <line x1="9" y1="15" x2="15" y2="15"/>
            </svg>
            <div style="font-size: 16px; font-weight: 500; margin-bottom: 4px;">Перетягніть файли сюди</div>
            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">або натисніть для вибору</div>
            <div style="font-size: 12px; color: var(--text-secondary);">PDF, XLSX, DOCX, PNG, JPG (до 10MB)</div>
          </div>
        </div>

        <!-- Selected Files Preview -->
        <div id="uploadFilesPreview" class="upload-files-preview" style="display: none;">
          <div style="font-size: 13px; font-weight: 500; margin-bottom: 8px; color: var(--text);">Вибрані файли:</div>
          <div id="uploadFilesList" class="upload-files-list"></div>
        </div>

        <!-- Case Info (fixed for case-detail page) -->
        <div class="upload-field">
          <label style="font-size: 13px; font-weight: 500; margin-bottom: 8px; display: block; color: var(--text);">
            Кейс
          </label>
          <div style="padding: 10px 12px; background: var(--bg-panel); border: 1px solid var(--divider); border-radius: var(--radius-sm); font-size: 13px; color: var(--accent);">
            F1-SEA-2026-02451
          </div>
        </div>

        <!-- Document Type Selection (Optional) -->
        <div class="upload-field">
          <label style="font-size: 13px; font-weight: 500; margin-bottom: 8px; display: block; color: var(--text);">
            Тип документа <span style="font-size: 11px; color: var(--text-muted); font-weight: normal;">(опціонально)</span>
          </label>
          <select id="uploadDocTypeSelect" class="upload-select">
            <option value="">AI визначить автоматично</option>
            <option value="INVOICE">INVOICE</option>
            <option value="PACKING_LIST">PACKING_LIST</option>
            <option value="BL_DRAFT">BL_DRAFT</option>
            <option value="POA">POA</option>
            <option value="CERTIFICATE">CERTIFICATE</option>
            <option value="OTHER">OTHER</option>
          </select>
        </div>
      </div>
      <div class="upload-modal-actions">
        <button class="btn btn-secondary" onclick="UploadModal.close()">Скасувати</button>
        <button class="btn btn-primary" onclick="UploadModal.upload()">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          Завантажити
        </button>
      </div>
    </div>
  </div>

  <!-- Approval Details Modal -->
  <div id="approvalModal" class="upload-modal" style="display: none;">
    <div class="upload-modal-overlay" onclick="ApprovalManager.closeDetails()"></div>
    <div class="upload-modal-content" onclick="event.stopPropagation()" style="max-width: 900px;">
      <div class="upload-modal-header">
        <h3>Approval: <span id="approvalTypeTitle">QUOTE_APPROVAL</span></h3>
        <button class="upload-modal-close" onclick="ApprovalManager.closeDetails()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="upload-modal-body">
        <div class="doc-viewer-meta" style="margin-bottom: 12px; padding-bottom: 12px;">
          <div class="doc-viewer-meta-item">
            <span class="doc-viewer-meta-label">Approval ID:</span>
            <span class="doc-viewer-meta-value" id="approvalIdValue"></span>
          </div>
          <div class="doc-viewer-meta-item">
            <span class="doc-viewer-meta-label">Status:</span>
            <span class="doc-viewer-meta-value" id="approvalStatusValue"></span>
          </div>
          <div class="doc-viewer-meta-item">
            <span class="doc-viewer-meta-label">Requested:</span>
            <span class="doc-viewer-meta-value" id="approvalRequestedValue"></span>
          </div>
          <div class="doc-viewer-meta-item">
            <span class="doc-viewer-meta-label">Case:</span>
            <span class="doc-viewer-meta-value" style="color: var(--accent);">F1-SEA-2026-02451</span>
          </div>
        </div>

        <div class="doc-viewer-content-grid" style="grid-template-columns: 1fr 1fr;">
          <div class="doc-viewer-preview" style="min-height: 260px;">
            <div style="font-weight: 600; margin-bottom: 10px;">Request snapshot (immutable)</div>
            <pre id="approvalRequestSnapshot" style="white-space: pre-wrap; margin:0; font-size: 12px; color: var(--text-secondary);"></pre>
          </div>
          <div class="doc-viewer-extracted">
            <div class="extracted-header">
              <h4 style="margin:0;">Що зміниться після рішення</h4>
              <span class="extracted-badge medium">approval gate</span>
            </div>
            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
              <ul style="margin: 0; padding-left: 18px;">
                <li>Рішення буде зафіксоване в <code>approvals.decision_snapshot</code> + <code>decision_comment</code></li>
                <li>В timeline з’явиться <code>APPROVAL_APPROVED</code> або <code>APPROVAL_REJECTED</code> (actor: HUMAN)</li>
                <li>Workflow (n8n) виконає дію та оновить <code>cases.state</code> (UI напряму state не змінює)</li>
              </ul>
            </div>
            <div style="margin-top: 14px;">
              <label style="display:block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Коментар (decision_comment):</label>
              <textarea id="approvalDecisionComment" placeholder="Опціонально: пояснення/правки…" style="width: 100%; min-height: 70px; padding: 8px; border: 1px solid var(--divider); border-radius: var(--radius-sm); background: var(--bg-panel); color: var(--text); font-family: inherit; font-size: 12px; resize: vertical;"></textarea>
            </div>
          </div>
        </div>
      </div>
      <div class="upload-modal-actions">
        <button class="btn btn-secondary" onclick="ApprovalManager.closeDetails()">Закрити</button>
        <button class="btn btn-secondary" onclick="ApprovalManager.openEdit()">Edit & Approve</button>
        <button class="btn btn-danger" onclick="ApprovalManager.openReject()">Reject</button>
        <button class="btn btn-primary" onclick="ApprovalManager.openConfirm()">Approve</button>
      </div>
    </div>
  </div>

  <!-- Approval Confirm Modal -->
  <div id="approvalConfirmModal" class="reject-reason-modal" style="display: none;" onclick="if(event.target === this) ApprovalManager.closeConfirm()">
    <div class="reject-reason-content" onclick="event.stopPropagation()" style="max-width: 520px;">
      <h4>Підтвердити approval</h4>
      <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
        Підтвердити <strong id="confirmApprovalTitle">QUOTE_APPROVAL</strong> для кейсу <strong>F1-SEA-2026-02451</strong>?
      </p>
      <div style="display: flex; gap: 8px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="ApprovalManager.closeConfirm()">Скасувати</button>
        <button class="btn btn-primary" onclick="ApprovalManager.confirmApprove()">Підтвердити</button>
      </div>
    </div>
  </div>

  <!-- Approval Reject Modal -->
  <div id="approvalRejectModal" class="reject-reason-modal" style="display: none;" onclick="if(event.target === this) ApprovalManager.closeReject()">
    <div class="reject-reason-content" onclick="event.stopPropagation()" style="max-width: 560px;">
      <h4>Відхилити approval</h4>
      <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
        Вкажіть причину відхилення <strong id="rejectApprovalTitle">QUOTE_APPROVAL</strong>
      </p>
      <textarea id="approvalRejectReasonInput" placeholder="Наприклад: потрібно уточнити маржу / невірні габарити / відсутній документ…" style="width: 100%; min-height: 90px; padding: 8px; border: 1px solid var(--divider); border-radius: var(--radius-sm); background: var(--bg-panel); color: var(--text); font-family: inherit; font-size: 13px; resize: vertical;"></textarea>
      <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px;">
        <button class="btn btn-secondary" onclick="ApprovalManager.closeReject()">Скасувати</button>
        <button class="btn btn-danger" onclick="ApprovalManager.confirmReject()">Відхилити</button>
      </div>
    </div>
  </div>

  <!-- Quote Edit & Approve Modal -->
  <div id="quoteEditModal" class="reject-reason-modal" style="display: none;" onclick="if(event.target === this) ApprovalManager.closeEdit()">
    <div class="reject-reason-content" onclick="event.stopPropagation()" style="max-width: 640px;">
      <h4>Edit & Approve: Quote</h4>
      <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
        Внесіть правки в чернетку та підтвердьте (буде записано в <code>decision_snapshot</code>).
      </p>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div>
          <label style="display:block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Base cost (USD)</label>
          <input id="editQuoteBaseCost" type="number" value="2450" style="width:100%; padding: 8px 12px; border: 1px solid var(--divider); border-radius: var(--radius-sm); background: var(--bg-panel); color: var(--text); font-size: 13px;">
        </div>
        <div>
          <label style="display:block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Margin (USD)</label>
          <input id="editQuoteMargin" type="number" value="350" style="width:100%; padding: 8px 12px; border: 1px solid var(--divider); border-radius: var(--radius-sm); background: var(--bg-panel); color: var(--text); font-size: 13px;">
        </div>
        <div>
          <label style="display:block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Validity days</label>
          <input id="editQuoteValidity" type="number" value="7" style="width:100%; padding: 8px 12px; border: 1px solid var(--divider); border-radius: var(--radius-sm); background: var(--bg-panel); color: var(--text); font-size: 13px;">
        </div>
        <div>
          <label style="display:block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Total (USD)</label>
          <input id="editQuoteTotal" type="number" value="2800" style="width:100%; padding: 8px 12px; border: 1px solid var(--divider); border-radius: var(--radius-sm); background: var(--bg-panel); color: var(--text); font-size: 13px;" disabled>
        </div>
      </div>
      <div style="margin-top: 12px;">
        <label style="display:block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Assumptions (one per line)</label>
        <textarea id="editQuoteAssumptions" style="width: 100%; min-height: 90px; padding: 8px; border: 1px solid var(--divider); border-radius: var(--radius-sm); background: var(--bg-panel); color: var(--text); font-family: inherit; font-size: 13px; resize: vertical;">Stackable cargo
No dangerous goods
Standard container load
Yiwu → Shenzhen → Odessa → Kyiv</textarea>
      </div>
      <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px;">
        <button class="btn btn-secondary" onclick="ApprovalManager.closeEdit()">Скасувати</button>
        <button class="btn btn-primary" onclick="ApprovalManager.saveEditAndApprove()">Save & Approve</button>
      </div>
    </div>
  </div>
</body>
</html>
